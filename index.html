<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ¡ãƒ¢PWA</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#667eea">

<style>
body { margin:0; font-family:sans-serif; background:#f5f5f5; }
header { position:sticky; top:0; background:#667eea; color:white; padding:12px; text-align:center; }
.hidden{display:none;}
input,textarea,select,button{width:100%;padding:10px;margin-bottom:8px;}
button{border:none;border-radius:6px;}
ul{list-style:none;padding:0;}
li{background:white;margin:8px;padding:12px;border-radius:8px;}
.note-title{font-weight:bold;}
.note-meta{font-size:12px;color:#666;}
.fab{position:fixed;bottom:20px;right:20px;background:#667eea;color:white;width:56px;height:56px;border-radius:50%;font-size:28px;}
.deleteBtn{background:#e74c3c;color:white;}
.restoreBtn{background:#2ecc71;color:white;}
.exportBtn{background:#3498db;color:white;}
.backupBtn{background:#34495e;color:white;}
</style>
</head>
<body>

<header id="headerTitle">ãƒ¡ãƒ¢ä¸€è¦§</header>

<div id="listView">
  <input id="searchInput" placeholder="æ¤œç´¢" oninput="loadList()">
  <select id="categoryFilter" onchange="loadList()">
    <option value="">ã™ã¹ã¦</option>
    <option value="ä»•äº‹">ä»•äº‹</option>
    <option value="ç§ç”¨">ç§ç”¨</option>
    <option value="ãã®ä»–">ãã®ä»–</option>
  </select>
  <button onclick="showTrash()">ğŸ—‘ ã‚´ãƒŸç®±</button>
  <button class="backupBtn" onclick="backupAll()">ğŸ“¦ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
  <button class="backupBtn" onclick="restoreAll()">ğŸ“¥ å¾©å…ƒ</button>
  <ul id="noteList"></ul>
  <button class="fab" onclick="newNote()">ï¼‹</button>
</div>

<div id="editView" class="hidden">
  <input id="titleInput" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
  <select id="categoryInput">
    <option value="ä»•äº‹">ä»•äº‹</option>
    <option value="ç§ç”¨">ç§ç”¨</option>
    <option value="ãã®ä»–">ãã®ä»–</option>
  </select>
  <textarea id="contentInput" rows="10" placeholder="å†…å®¹"></textarea>
  <button onclick="saveNote()">ä¿å­˜</button>
  <button class="exportBtn" onclick="exportNote()">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
  <button class="deleteBtn" onclick="deleteNote()">å‰Šé™¤</button>
  <button onclick="showList()">æˆ»ã‚‹</button>
</div>

<div id="trashView" class="hidden">
  <ul id="trashList"></ul>
  <button onclick="showList()">æˆ»ã‚‹</button>
</div>

<input type="file" id="backupInput" accept=".json" class="hidden">

<script>
let db,currentId=null;
const req=indexedDB.open("memoDB",1);
req.onupgradeneeded=e=>{
  const db=e.target.result;
  if(!db.objectStoreNames.contains("notes")){
    db.createObjectStore("notes",{keyPath:"id"});
  }
};
req.onsuccess=e=>{db=e.target.result;loadList();};

function showList(){editView.classList.add("hidden");trashView.classList.add("hidden");listView.classList.remove("hidden");headerTitle.textContent="ãƒ¡ãƒ¢ä¸€è¦§";loadList();}
function showEdit(){listView.classList.add("hidden");trashView.classList.add("hidden");editView.classList.remove("hidden");headerTitle.textContent="ç·¨é›†";}
function showTrash(){listView.classList.add("hidden");editView.classList.add("hidden");trashView.classList.remove("hidden");headerTitle.textContent="ã‚´ãƒŸç®±";loadTrash();}

function newNote(){currentId=Date.now();titleInput.value="";contentInput.value="";categoryInput.value="ãã®ä»–";showEdit();}
function saveNote(){
  const note={id:currentId,title:titleInput.value||"ï¼ˆç„¡é¡Œï¼‰",content:contentInput.value,category:categoryInput.value,updated:new Date().toLocaleString(),deleted:false};
  db.transaction("notes","readwrite").objectStore("notes").put(note);showList();
}
function deleteNote(){
  const s=db.transaction("notes","readwrite").objectStore("notes");
  s.get(currentId).onsuccess=e=>{const n=e.target.result;n.deleted=true;s.put(n);showList();};
}
function loadList(){
  const k=searchInput.value,f=categoryFilter.value;
  db.transaction("notes").objectStore("notes").getAll().onsuccess=e=>{
    noteList.innerHTML="";
    e.target.result.filter(n=>!n.deleted)
      .filter(n=>(!f||n.category===f)&&(n.title.includes(k)||n.content.includes(k)))
      .sort((a,b)=>b.id-a.id)
      .forEach(n=>{
        const li=document.createElement("li");
        li.innerHTML=`<div class="note-title">${n.title}</div><div class="note-meta">${n.category} / ${n.updated}</div>`;
        li.onclick=()=>{currentId=n.id;titleInput.value=n.title;contentInput.value=n.content;categoryInput.value=n.category;showEdit();};
        noteList.appendChild(li);
      });
  };
}
function loadTrash(){
  db.transaction("notes").objectStore("notes").getAll().onsuccess=e=>{
    trashList.innerHTML="";
    e.target.result.filter(n=>n.deleted).forEach(n=>{
      const li=document.createElement("li");
      li.innerHTML=`<div class="note-title">${n.title}</div>
      <button class="restoreBtn" onclick="restore(${n.id})">å¾©å…ƒ</button>
      <button class="deleteBtn" onclick="permanentDelete(${n.id})">å®Œå…¨å‰Šé™¤</button>`;
      trashList.appendChild(li);
    });
  };
}
function restore(id){
  const s=db.transaction("notes","readwrite").objectStore("notes");
  s.get(id).onsuccess=e=>{const n=e.target.result;n.deleted=false;s.put(n);loadTrash();};
}
function permanentDelete(id){db.transaction("notes","readwrite").objectStore("notes").delete(id);loadTrash();}

/* â˜… txt / md æœ€å®‰å®šï¼ˆUTF-8 + BOMï¼‰ */
function exportNote(){
  const format=prompt("txt / md / json","txt"); if(!format)return;
  const title=(titleInput.value||"ç„¡é¡Œ").replace(/[\\/:*?"<>|]/g,"_");
  const category=categoryInput.value,content=contentInput.value,updated=new Date().toLocaleString();
  let text="",ext="txt",mime="text/plain";
  if(format==="md"){
    text=`# ${title}\n\n- ã‚«ãƒ†ã‚´ãƒª: ${category}\n- æ›´æ–°æ—¥: ${updated}\n\n---\n\n${content}`;
    ext="md";
  }else if(format==="json"){
    text=JSON.stringify({title,category,content,updated},null,2);
    mime="application/json";ext="json";
  }else{
    text=`ã€${title}ã€‘\nã‚«ãƒ†ã‚´ãƒª: ${category}\næ›´æ–°æ—¥: ${updated}\n\n${content}`;
  }
  const bom="\uFEFF";
  const blob=new Blob([bom+text],{type:mime+";charset=utf-8"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`${title}.${ext}`;
  a.click();
}

function backupAll(){
  db.transaction("notes").objectStore("notes").getAll().onsuccess=e=>{
    const blob=new Blob([JSON.stringify({notes:e.target.result},null,2)],{type:"application/json"});
    const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="memo-backup.json";a.click();
  };
}
function restoreAll(){backupInput.click();}
backupInput.onchange=e=>{
  const r=new FileReader();
  r.onload=()=>{const d=JSON.parse(r.result);const s=db.transaction("notes","readwrite").objectStore("notes");d.notes.forEach(n=>s.put(n));showList();};
  r.readAsText(e.target.files[0]);
};

if("serviceWorker"in navigator){navigator.serviceWorker.register("sw.js");}
</script>

</body>
</html>
