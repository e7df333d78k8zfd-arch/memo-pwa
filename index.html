<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>シンプルメモ</title>

<style>
body {
  font-family: system-ui, sans-serif;
  margin: 0;
  padding: 10px;
}

header {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

textarea {
  width: 100%;
  height: 120px;
}

.memo {
  border: 1px solid #ccc;
  padding: 8px;
  margin-top: 6px;
}

small {
  color: #666;
}
</style>
</head>
<body>

<!-- ===== 上部操作バー ===== -->
<header>
  <input id="searchInput" placeholder="検索">
  <select id="filterSelect">
    <option value="all">すべて</option>
    <option value="メモ">メモ</option>
    <option value="仕事">仕事</option>
    <option value="日記">日記</option>
    <option value="ゴミ箱">ゴミ箱</option>
  </select>
  <button onclick="backupAll()">バックアップ</button>
  <button onclick="startRestore()">復元</button>
</header>

<hr>

<!-- ===== 新規メモ入力 ===== -->
<select id="categorySelect">
  <option value="メモ">メモ</option>
  <option value="仕事">仕事</option>
  <option value="日記">日記</option>
</select>

<textarea id="memoText" placeholder="ここにメモを書く"></textarea>
<button onclick="saveMemo()">保存</button>

<!-- ===== メモ一覧 ===== -->
<div id="memoList"></div>

<!-- 復元用（非表示） -->
<input type="file" id="fileInput" accept=".json" style="display:none;">

<script>
/* ===============================
   IndexedDB 初期化
================================ */
let db;
const request = indexedDB.open("memoDB", 1);

request.onupgradeneeded = function(e) {
  db = e.target.result;
  db.createObjectStore("memos", { keyPath: "id" });
};

request.onsuccess = function(e) {
  db = e.target.result;
  loadAndRender();
};

/* ===============================
   メモ保存
================================ */
function saveMemo() {
  const text = memoText.value.trim();
  if (text === "") return;

  const memo = {
    id: Date.now(),
    text: text,
    category: categorySelect.value,
    date: new Date().toLocaleString(),
    deleted: false
  };

  const tx = db.transaction("memos", "readwrite");
  tx.objectStore("memos").put(memo);

  memoText.value = "";
  loadAndRender();
}

/* ===============================
   一覧表示
================================ */
function loadAndRender() {
  const tx = db.transaction("memos", "readonly");
  const store = tx.objectStore("memos");

  store.getAll().onsuccess = function(e) {
    renderList(e.target.result);
  };
}

function renderList(memos) {
  memoList.innerHTML = "";

  const keyword = searchInput.value;
  const filter = filterSelect.value;

  memos
    .filter(m => filterMemo(m, keyword, filter))
    .sort((a, b) => b.id - a.id)
    .forEach(m => {
      memoList.appendChild(createMemoElement(m));
    });
}

/* ===============================
   フィルタ判定
================================ */
function filterMemo(memo, keyword, filter) {
  if (!memo.text.includes(keyword)) return false;

  if (filter === "all") return !memo.deleted;
  if (filter === "ゴミ箱") return memo.deleted;

  return memo.category === filter && !memo.deleted;
}

/* ===============================
   メモ表示HTML
================================ */
function createMemoElement(memo) {
  const div = document.createElement("div");
  div.className = "memo";

  div.innerHTML = `
    <div>${memo.text.replace(/\n/g, "<br>")}</div>
    <small>${memo.date} / ${memo.category}</small><br>
    ${
      memo.deleted
        ? `<button onclick="deleteForever(${memo.id})">完全削除</button>`
        : `<button onclick="moveToTrash(${memo.id})">ゴミ箱へ</button>`
    }
  `;

  return div;
}

/* ===============================
   ゴミ箱処理
================================ */
function moveToTrash(id) {
  updateMemo(id, m => m.deleted = true);
}

function deleteForever(id) {
  const tx = db.transaction("memos", "readwrite");
  tx.objectStore("memos").delete(id);
  loadAndRender();
}

function updateMemo(id, updater) {
  const tx = db.transaction("memos", "readwrite");
  const store = tx.objectStore("memos");

  store.get(id).onsuccess = function(e) {
    const memo = e.target.result;
    updater(memo);
    store.put(memo);
    loadAndRender();
  };
}

/* ===============================
   検索・フィルタ連動
================================ */
searchInput.oninput = loadAndRender;
filterSelect.onchange = loadAndRender;

/* ===============================
   バックアップ
================================ */
function backupAll() {
  const tx = db.transaction("memos", "readonly");
  tx.objectStore("memos").getAll().onsuccess = function(e) {
    const json = JSON.stringify(e.target.result, null, 2);
    const blob = new Blob([json], { type: "application/json" });

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "memo-backup.json";
    a.click();
  };
}

/* ===============================
   復元
================================ */
function startRestore() {
  fileInput.click();
}

fileInput.onchange = function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function() {
    try {
      const data = JSON.parse(reader.result);
      const tx = db.transaction("memos", "readwrite");
      const store = tx.objectStore("memos");

      data.forEach(m => store.put(m));
      loadAndRender();
    } catch {
      alert("復元に失敗しました");
    }
  };
  reader.readAsText(file);
};
</script>

</body>
</html>
