<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ¡ãƒ¢PWAï¼ˆSQLiteæ°¸ç¶šç‰ˆï¼‰</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#667eea">

<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>

<style>
body { margin:0; font-family:sans-serif; background:#f5f5f5; }
header { position:sticky; top:0; background:#667eea; color:#fff; padding:12px; text-align:center; }
.hidden { display:none; }
input, textarea, select, button { width:100%; padding:10px; margin-bottom:8px; }
button { border:none; border-radius:6px; }
ul { list-style:none; padding:0; }
li { background:#fff; margin:8px; padding:12px; border-radius:8px; }
.note-title { font-weight:bold; }
.note-meta { font-size:12px; color:#666; }
.fab { position:fixed; bottom:20px; right:20px; background:#667eea; color:#fff;
  width:56px; height:56px; border-radius:50%; font-size:28px; }
.deleteBtn { background:#e74c3c; color:#fff; }
.restoreBtn { background:#2ecc71; color:#fff; }
.backupBtn { background:#8e44ad; color:#fff; }

#contentInput { min-height:60vh; }
</style>
</head>
<body>

<header id="headerTitle">ãƒ¡ãƒ¢ä¸€è¦§</header>

<div id="listView">
  <input id="searchInput" placeholder="æ¤œç´¢" oninput="loadList()">

  <select id="categoryFilter" onchange="loadList()">
    <option value="">ã™ã¹ã¦</option>
    <option value="ä»•äº‹">ä»•äº‹</option>
    <option value="ç§ç”¨">ç§ç”¨</option>
    <option value="ãã®ä»–">ãã®ä»–</option>
  </select>

  <button onclick="showTrash()">ğŸ—‘ ã‚´ãƒŸç®±</button>
  <button class="backupBtn" onclick="downloadDB()">ğŸ“¦ DBãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>

  <ul id="noteList"></ul>
  <button class="fab" onclick="newNote()">ï¼‹</button>
</div>

<div id="editView" class="hidden">
  <input id="titleInput" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
  <select id="categoryInput">
    <option value="ä»•äº‹">ä»•äº‹</option>
    <option value="ç§ç”¨">ç§ç”¨</option>
    <option value="ãã®ä»–">ãã®ä»–</option>
  </select>
  <textarea id="contentInput" placeholder="å†…å®¹"></textarea>

  <button onclick="saveNote()">ä¿å­˜</button>
  <button class="deleteBtn" onclick="deleteNote()">å‰Šé™¤</button>
  <button onclick="showList()">æˆ»ã‚‹</button>
</div>

<div id="trashView" class="hidden">
  <ul id="trashList"></ul>
  <button onclick="showList()">æˆ»ã‚‹</button>
</div>

<script>
let SQL, db;
let currentId = null;
const DB_KEY = "memo-sqlite-db";

/* ===== IndexedDBï¼ˆSQLiteãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ç”¨ï¼‰ ===== */
function openStore() {
  return new Promise(res => {
    const r = indexedDB.open("sqlite-store", 1);
    r.onupgradeneeded = e => e.target.result.createObjectStore("files");
    r.onsuccess = e => res(e.target.result);
  });
}

async function loadDBFile() {
  const idb = await openStore();
  return new Promise(res => {
    const tx = idb.transaction("files");
    const req = tx.objectStore("files").get(DB_KEY);
    req.onsuccess = () => res(req.result || null);
  });
}

async function saveDBFile() {
  const data = db.export();
  const idb = await openStore();
  const tx = idb.transaction("files","readwrite");
  tx.objectStore("files").put(data, DB_KEY);
}

/* ===== SQLite åˆæœŸåŒ– ===== */
initSqlJs({ locateFile: f =>
  `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/${f}`
}).then(async lib => {
  SQL = lib;
  const saved = await loadDBFile();
  db = saved ? new SQL.Database(saved) : new SQL.Database();

  db.run(`
    CREATE TABLE IF NOT EXISTS notes (
      id INTEGER PRIMARY KEY,
      title TEXT,
      content TEXT,
      category TEXT,
      updated TEXT,
      deleted INTEGER
    );
  `);

  loadList();
});

/* ===== ç”»é¢åˆ‡æ›¿ ===== */
function showList() {
  listView.classList.remove("hidden");
  editView.classList.add("hidden");
  trashView.classList.add("hidden");
  headerTitle.textContent = "ãƒ¡ãƒ¢ä¸€è¦§";
  loadList();
}
function showEdit() {
  listView.classList.add("hidden");
  editView.classList.remove("hidden");
  trashView.classList.add("hidden");
  headerTitle.textContent = "ç·¨é›†";
}
function showTrash() {
  listView.classList.add("hidden");
  editView.classList.add("hidden");
  trashView.classList.remove("hidden");
  headerTitle.textContent = "ã‚´ãƒŸç®±";
  loadTrash();
}

/* ===== CRUD ===== */
function newNote() {
  currentId = Date.now();
  titleInput.value = "";
  contentInput.value = "";
  categoryInput.value = "ãã®ä»–";
  showEdit();
}

function saveNote() {
  db.run(
    `INSERT OR REPLACE INTO notes VALUES (?,?,?,?,?,0)`,
    [currentId, titleInput.value||"ï¼ˆç„¡é¡Œï¼‰",
     contentInput.value, categoryInput.value,
     new Date().toLocaleString()]
  );
  saveDBFile();
  showList();
}

function deleteNote() {
  db.run(`UPDATE notes SET deleted=1 WHERE id=?`, [currentId]);
  saveDBFile();
  showList();
}

/* ===== ä¸€è¦§ ===== */
function loadList() {
  noteList.innerHTML = "";
  const keyword = searchInput.value||"";
  const cat = categoryFilter.value||"";
  const res = db.exec(`SELECT * FROM notes WHERE deleted=0 ORDER BY id DESC`);
  if (!res[0]) return;

  res[0].values.forEach(r => {
    const [id,title,content,category,updated] = r;
    if ((cat && category!==cat) ||
        (!title.includes(keyword) && !content.includes(keyword))) return;
    const li = document.createElement("li");
    li.innerHTML = `<div class="note-title">${title}</div>
                    <div class="note-meta">${category} / ${updated}</div>`;
    li.onclick = () => openNote(r);
    noteList.appendChild(li);
  });
}

function openNote(r) {
  [currentId,titleInput.value,
   contentInput.value,categoryInput.value] = r;
  showEdit();
}

/* ===== ã‚´ãƒŸç®± ===== */
function loadTrash() {
  trashList.innerHTML = "";
  const res = db.exec(`SELECT * FROM notes WHERE deleted=1`);
  if (!res[0]) return;
  res[0].values.forEach(r => {
    const li = document.createElement("li");
    li.innerHTML = `
      <div class="note-title">${r[1]}</div>
      <button class="restoreBtn" onclick="restore(${r[0]})">å¾©å…ƒ</button>
      <button class="deleteBtn" onclick="permanentDelete(${r[0]})">å®Œå…¨å‰Šé™¤</button>`;
    trashList.appendChild(li);
  });
}

function restore(id) {
  db.run(`UPDATE notes SET deleted=0 WHERE id=?`, [id]);
  saveDBFile();
  loadTrash();
}

function permanentDelete(id) {
  db.run(`DELETE FROM notes WHERE id=?`, [id]);
  saveDBFile();
  loadTrash();
}

/* ===== DBãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— ===== */
function downloadDB() {
  const blob = new Blob([db.export()]);
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "memo.db";
  a.click();
}
</script>

</body>
</html>
