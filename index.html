<script>
/* =========================
   グローバル変数
========================= */
let db = null;
let currentId = null;
let trashMode = false;

/* =========================
   IndexedDB 初期化
========================= */
const req = indexedDB.open("memoDB", 1);

req.onupgradeneeded = e => {
  const database = e.target.result;
  if (!database.objectStoreNames.contains("notes")) {
    database.createObjectStore("notes", { keyPath: "id" });
  }
};

req.onsuccess = e => {
  db = e.target.result;

  // 初期表示
  loadCategories();
  loadList();

  // ★ DB準備完了後にスプラッシュ解除
  const splash = document.getElementById("splash");
  if (splash) splash.classList.add("hidden");
};

req.onerror = () => {
  alert("データベースの初期化に失敗しました");
};

/* =========================
   画面切替
========================= */
function showList() {
  document.getElementById("editView").classList.add("hidden");
  document.getElementById("trashView").classList.add("hidden");
  document.getElementById("listView").classList.remove("hidden");
  document.getElementById("headerTitle").textContent = "メモ一覧";
  trashMode = false;
  loadList();
}

function showEdit() {
  document.getElementById("listView").classList.add("hidden");
  document.getElementById("trashView").classList.add("hidden");
  document.getElementById("editView").classList.remove("hidden");
  document.getElementById("headerTitle").textContent = "編集";
}

function toggleTrash() {
  trashMode = !trashMode;
  document.getElementById("listView").classList.toggle("hidden");
  document.getElementById("trashView").classList.toggle("hidden");
  document.getElementById("headerTitle").textContent = trashMode ? "ゴミ箱" : "メモ一覧";
  if (trashMode) loadTrash();
}

/* =========================
   新規メモ
========================= */
function newNote() {
  currentId = Date.now();
  document.getElementById("titleInput").value = "";
  document.getElementById("contentInput").value = "";
  document.getElementById("categoryInput").value = "その他";
  showEdit();
}

/* =========================
   保存
========================= */
function saveNote() {
  const note = {
    id: currentId,
    title: titleInput.value || "（無題）",
    content: contentInput.value,
    category: categoryInput.value || "その他",
    updated: new Date().toLocaleString(),
    deleted: false
  };

  const tx = db.transaction("notes", "readwrite");
  tx.objectStore("notes").put(note);
  showList();
}

/* =========================
   削除（ゴミ箱）
========================= */
function deleteNote() {
  const tx = db.transaction("notes", "readwrite");
  const store = tx.objectStore("notes");
  store.get(currentId).onsuccess = e => {
    const note = e.target.result;
    if (!note) return;
    note.deleted = true;
    store.put(note);
    showList();
  };
}

/* =========================
   一覧表示（検索・カテゴリ）
========================= */
function loadList() {
  if (trashMode) return;

  const keyword = document.getElementById("searchInput").value || "";
  const cat = document.getElementById("categoryFilter").value || "";

  const tx = db.transaction("notes", "readonly");
  tx.objectStore("notes").getAll().onsuccess = e => {
    const list = document.getElementById("noteList");
    list.innerHTML = "";

    e.target.result
      .filter(n => !n.deleted)
      .filter(n =>
        (!cat || n.category === cat) &&
        (n.title.includes(keyword) || n.content.includes(keyword))
      )
      .sort((a, b) => b.id - a.id)
      .forEach(n => {
        const li = document.createElement("li");
        li.innerHTML = `
          <div class="note-title">${n.title}</div>
          <div class="note-meta">${n.category} / ${n.updated}</div>
        `;
        li.onclick = () => openNote(n);
        list.appendChild(li);
      });
  };
}

/* =========================
   編集で開く
========================= */
function openNote(note) {
  currentId = note.id;
  titleInput.value = note.title;
  contentInput.value = note.content;
  categoryInput.value = note.category || "その他";
  showEdit();
}

/* =========================
   カテゴリ一覧
========================= */
function loadCategories() {
  const tx = db.transaction("notes", "readonly");
  tx.objectStore("notes").getAll().onsuccess = e => {
    const filter = document.getElementById("categoryFilter");
    filter.innerHTML = '<option value="">すべてのカテゴリ</option>';

    const cats = [...new Set(
      e.target.result
        .filter(n => !n.deleted)
        .map(n => n.category)
    )];

    cats.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      filter.appendChild(opt);
    });
  };
}

/* =========================
   ゴミ箱
========================= */
function loadTrash() {
  const tx = db.transaction("notes", "readonly");
  tx.objectStore("notes").getAll().onsuccess = e => {
    const list = document.getElementById("trashList");
    list.innerHTML = "";

    e.target.result
      .filter(n => n.deleted)
      .forEach(n => {
        const li = document.createElement("li");
        li.innerHTML = `
          <div class="note-title">${n.title}</div>
          <button onclick="restore(${n.id})">復元</button>
          <button onclick="permanentDelete(${n.id})">完全削除</button>
        `;
        list.appendChild(li);
      });
  };
}

function restore(id) {
  const tx = db.transaction("notes", "readwrite");
  const store = tx.objectStore("notes");
  store.get(id).onsuccess = e => {
    const n = e.target.result;
    if (!n) return;
    n.deleted = false;
    store.put(n);
    loadTrash();
  };
}

function permanentDelete(id) {
  db.transaction("notes", "readwrite")
    .objectStore("notes")
    .delete(id);
  loadTrash();
}

/* =========================
   エクスポート（1メモ1ファイル）
========================= */
function exportNote() {
  const data = {
    title: titleInput.value,
    category: categoryInput.value,
    content: contentInput.value,
    updated: new Date().toISOString()
  };

  const blob = new Blob(
    [JSON.stringify(data, null, 2)],
    { type: "application/json" }
  );

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = (data.title || "memo") + ".json";
  a.click();
}

/* =========================
   PWA
========================= */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>
