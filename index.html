<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>シンプルメモ</title>
<link rel="manifest" href="manifest.json">
<style>
body {
  font-family: system-ui, sans-serif;
  margin: 0;
  padding: 10px;
}
header {
  display: flex;
  gap: 5px;
  flex-wrap: wrap;
}
input, select, textarea, button {
  font-size: 16px;
}
textarea {
  width: 100%;
  height: 120px;
}
.memo {
  border: 1px solid #ccc;
  padding: 8px;
  margin-top: 5px;
}
.memo small {
  color: #666;
}
.hidden {
  display: none;
}
</style>
</head>
<body>

<header>
  <input id="search" placeholder="検索">
  <select id="filter">
    <option value="all">すべて</option>
    <option value="メモ">メモ</option>
    <option value="仕事">仕事</option>
    <option value="日記">日記</option>
    <option value="ゴミ箱">ゴミ箱</option>
  </select>
  <button onclick="backup()">バックアップ</button>
  <button onclick="restore()">復元</button>
</header>

<hr>

<select id="category">
  <option value="メモ">メモ</option>
  <option value="仕事">仕事</option>
  <option value="日記">日記</option>
</select>
<br><br>
<textarea id="content" placeholder="メモを書く"></textarea>
<br>
<button onclick="addMemo()">保存</button>

<div id="list"></div>

<input type="file" id="fileInput" class="hidden" accept=".json">

<script>
let db;
const req = indexedDB.open("memoDB", 1);

req.onupgradeneeded = e => {
  db = e.target.result;
  db.createObjectStore("memos", { keyPath: "id" });
};

req.onsuccess = e => {
  db = e.target.result;
  render();
};

function addMemo() {
  const text = content.value.trim();
  if (!text) return;
  const memo = {
    id: Date.now(),
    text,
    category: category.value,
    date: new Date().toLocaleString(),
    deleted: false
  };
  const tx = db.transaction("memos", "readwrite");
  tx.objectStore("memos").put(memo);
  content.value = "";
  render();
}

function render() {
  const list = document.getElementById("list");
  list.innerHTML = "";
  const tx = db.transaction("memos", "readonly");
  const store = tx.objectStore("memos");
  store.getAll().onsuccess = e => {
    const data = e.target.result;
    const f = filter.value;
    const q = search.value;
    data
      .filter(m =>
        (f === "all" ||
         (f === "ゴミ箱" ? m.deleted : m.category === f && !m.deleted)) &&
        m.text.includes(q)
      )
      .sort((a,b)=>b.id-a.id)
      .forEach(m => {
        const d = document.createElement("div");
        d.className = "memo";
        d.innerHTML = `
          <div>${m.text.replace(/\n/g,"<br>")}</div>
          <small>${m.date} / ${m.category}</small><br>
          ${m.deleted
            ? `<button onclick="remove(${m.id})">完全削除</button>`
            : `<button onclick="trash(${m.id})">ゴミ箱</button>`}
        `;
        list.appendChild(d);
      });
  };
}

function trash(id) {
  update(id, m => m.deleted = true);
}
function remove(id) {
  const tx = db.transaction("memos", "readwrite");
  tx.objectStore("memos").delete(id);
  render();
}
function update(id, fn) {
  const tx = db.transaction("memos", "readwrite");
  const store = tx.objectStore("memos");
  store.get(id).onsuccess = e => {
    const m = e.target.result;
    fn(m);
    store.put(m);
    render();
  };
}

search.oninput = filter.onchange = render;

/* ===== バックアップ ===== */
function backup() {
  const tx = db.transaction("memos", "readonly");
  tx.objectStore("memos").getAll().onsuccess = e => {
    const blob = new Blob(
      [JSON.stringify(e.target.result, null, 2)],
      { type: "application/json" }
    );
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "memo-backup.json";
    a.click();
  };
}

/* ===== 復元 ===== */
function restore() {
  fileInput.click();
}
fileInput.onchange = e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const data = JSON.parse(reader.result);
      const tx = db.transaction("memos", "readwrite");
      const store = tx.objectStore("memos");
      data.forEach(m => store.put(m));
      render();
    } catch {
      alert("復元に失敗しました");
    }
  };
  reader.readAsText(file);
};
</script>

</body>
</html>
